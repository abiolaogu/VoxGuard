# DragonflyDB Multi-Region Replication Configuration
# VoxGuard Production Setup
#
# Topology:
# - Lagos (Primary): Master node accepting writes
# - Abuja (Replica): Read-only replica
# - Asaba (Replica): Read-only replica

# ============================================================================
# PRIMARY NODE CONFIGURATION (Lagos)
# ============================================================================

# Run this configuration on the Lagos master node
# File: /etc/dragonfly/dragonfly-primary.conf

# Network binding
bind 0.0.0.0
port 6379

# Memory configuration
maxmemory 16gb
maxmemory-policy allkeys-lru

# Persistence for durability
dir /var/lib/dragonfly
dbfilename dump.rdb
save 900 1
save 300 10
save 60 10000

# AOF (Append-Only File) for crash safety
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Replication configuration (as master)
replicaof no one  # This is the master

# Security
requirepass ${DRAGONFLY_PASSWORD}
masterauth ${DRAGONFLY_PASSWORD}

# Performance tuning
tcp-backlog 511
timeout 0
tcp-keepalive 300

# Threading
proactor-threads 8  # Optimize for 8-core system

# Logging
loglevel notice
logfile /var/log/dragonfly/dragonfly.log

# Slow log for performance monitoring
slowlog-log-slower-than 10000  # 10ms
slowlog-max-len 128

# ============================================================================
# REPLICA NODE CONFIGURATION (Abuja/Asaba)
# ============================================================================

# Run this configuration on replica nodes
# File: /etc/dragonfly/dragonfly-replica.conf

# Network binding
bind 0.0.0.0
port 6379

# Memory configuration (smaller than primary)
maxmemory 8gb
maxmemory-policy allkeys-lru

# Replication configuration (as replica)
replicaof dragonfly-lagos.voxguard.internal 6379
masterauth ${DRAGONFLY_PASSWORD}

# Replica settings
replica-read-only yes
replica-serve-stale-data yes
replica-priority 100

# Replication backlog (for network interruptions)
repl-backlog-size 256mb
repl-backlog-ttl 3600  # 1 hour

# Replication timeout
repl-timeout 60
repl-ping-replica-period 10

# Enable diskless replication for faster sync
repl-diskless-sync yes
repl-diskless-sync-delay 5

# Security
requirepass ${DRAGONFLY_PASSWORD}

# Performance tuning
tcp-backlog 511
timeout 0
tcp-keepalive 300

# Threading (4 cores for replicas)
proactor-threads 4

# Logging
loglevel notice
logfile /var/log/dragonfly/dragonfly-replica.log

# Slow log
slowlog-log-slower-than 10000
slowlog-max-len 128

# ============================================================================
# SENTINEL CONFIGURATION (High Availability)
# ============================================================================

# Run Sentinel on 3+ nodes for automatic failover
# File: /etc/dragonfly/sentinel.conf

# Sentinel mode
sentinel monitor voxguard-master dragonfly-lagos.voxguard.internal 6379 2
sentinel auth-pass voxguard-master ${DRAGONFLY_PASSWORD}

# Failover thresholds
sentinel down-after-milliseconds voxguard-master 30000  # 30s
sentinel parallel-syncs voxguard-master 1
sentinel failover-timeout voxguard-master 180000  # 3 minutes

# Notification scripts (optional)
# sentinel notification-script voxguard-master /usr/local/bin/notify-failover.sh
# sentinel client-reconfig-script voxguard-master /usr/local/bin/reconfig-clients.sh

# Sentinel authentication
sentinel auth-user voxguard-master default
sentinel auth-pass voxguard-master ${DRAGONFLY_PASSWORD}

# Logging
logfile /var/log/dragonfly/sentinel.log
loglevel notice

# ============================================================================
# KUBERNETES DEPLOYMENT CONFIGURATION
# ============================================================================

# StatefulSet for DragonflyDB with replication
# File: dragonfly-statefulset.yaml

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: dragonfly-config
  namespace: voxguard-prod
data:
  dragonfly.conf: |
    bind 0.0.0.0
    port 6379
    maxmemory 16gb
    maxmemory-policy allkeys-lru
    appendonly yes
    appendfilename "appendonly.aof"
    appendfsync everysec
    tcp-keepalive 300
    proactor-threads 8
    loglevel notice
    slowlog-log-slower-than 10000

---
apiVersion: v1
kind: Secret
metadata:
  name: dragonfly-secret
  namespace: voxguard-prod
type: Opaque
stringData:
  password: ${DRAGONFLY_PASSWORD}  # Replace with actual password

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: dragonfly-primary
  namespace: voxguard-prod
  labels:
    app: dragonfly
    role: primary
    region: lagos
spec:
  serviceName: dragonfly-primary
  replicas: 1
  selector:
    matchLabels:
      app: dragonfly
      role: primary
  template:
    metadata:
      labels:
        app: dragonfly
        role: primary
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - dragonfly
              topologyKey: kubernetes.io/hostname
      containers:
      - name: dragonfly
        image: docker.dragonflydb.io/dragonflydb/dragonfly:v1.13.0
        args:
          - "--requirepass=$(DRAGONFLY_PASSWORD)"
          - "--maxmemory=16gb"
          - "--proactor_threads=8"
          - "--logtostderr"
        ports:
        - name: dragonfly
          containerPort: 6379
          protocol: TCP
        env:
        - name: DRAGONFLY_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dragonfly-secret
              key: password
        resources:
          requests:
            cpu: 4000m
            memory: 10Gi
          limits:
            cpu: 8000m
            memory: 18Gi
        volumeMounts:
        - name: data
          mountPath: /data
        livenessProbe:
          exec:
            command:
            - redis-cli
            - -a
            - $(DRAGONFLY_PASSWORD)
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        readinessProbe:
          exec:
            command:
            - redis-cli
            - -a
            - $(DRAGONFLY_PASSWORD)
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: ssd
      resources:
        requests:
          storage: 100Gi

---
apiVersion: v1
kind: Service
metadata:
  name: dragonfly-primary
  namespace: voxguard-prod
spec:
  type: ClusterIP
  selector:
    app: dragonfly
    role: primary
  ports:
  - name: dragonfly
    port: 6379
    targetPort: 6379

---
# Replica StatefulSet for Abuja/Asaba
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: dragonfly-replica
  namespace: voxguard-prod
  labels:
    app: dragonfly
    role: replica
spec:
  serviceName: dragonfly-replica
  replicas: 2  # One for Abuja, one for Asaba
  selector:
    matchLabels:
      app: dragonfly
      role: replica
  template:
    metadata:
      labels:
        app: dragonfly
        role: replica
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - dragonfly
            topologyKey: kubernetes.io/hostname
      containers:
      - name: dragonfly
        image: docker.dragonflydb.io/dragonflydb/dragonfly:v1.13.0
        args:
          - "--requirepass=$(DRAGONFLY_PASSWORD)"
          - "--replicaof=dragonfly-primary.voxguard-prod.svc.cluster.local:6379"
          - "--masterauth=$(DRAGONFLY_PASSWORD)"
          - "--maxmemory=8gb"
          - "--proactor_threads=4"
          - "--replica_announce_ip=$(POD_IP)"
          - "--logtostderr"
        ports:
        - name: dragonfly
          containerPort: 6379
          protocol: TCP
        env:
        - name: DRAGONFLY_PASSWORD
          valueFrom:
            secretKeyRef:
              name: dragonfly-secret
              key: password
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        resources:
          requests:
            cpu: 2000m
            memory: 6Gi
          limits:
            cpu: 4000m
            memory: 10Gi
        volumeMounts:
        - name: data
          mountPath: /data
        livenessProbe:
          exec:
            command:
            - redis-cli
            - -a
            - $(DRAGONFLY_PASSWORD)
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command:
            - redis-cli
            - -a
            - $(DRAGONFLY_PASSWORD)
            - ping
          initialDelaySeconds: 5
          periodSeconds: 5
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: ssd
      resources:
        requests:
          storage: 50Gi

---
apiVersion: v1
kind: Service
metadata:
  name: dragonfly-replica
  namespace: voxguard-prod
spec:
  type: ClusterIP
  selector:
    app: dragonfly
    role: replica
  ports:
  - name: dragonfly
    port: 6379
    targetPort: 6379

# ============================================================================
# REPLICATION MONITORING
# ============================================================================

# Check replication status (run on primary)
# redis-cli -a $DRAGONFLY_PASSWORD INFO replication

# Expected output on primary:
# role:master
# connected_slaves:2
# slave0:ip=10.1.x.x,port=6379,state=online,offset=xxxxx,lag=0
# slave1:ip=10.2.x.x,port=6379,state=online,offset=xxxxx,lag=0

# Check replication status (run on replica)
# redis-cli -a $DRAGONFLY_PASSWORD INFO replication

# Expected output on replica:
# role:slave
# master_host:dragonfly-lagos.voxguard.internal
# master_port:6379
# master_link_status:up
# master_last_io_seconds_ago:X
# master_sync_in_progress:0

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================

# Monitor replication lag
# redis-cli -a $DRAGONFLY_PASSWORD --latency

# Monitor command statistics
# redis-cli -a $DRAGONFLY_PASSWORD INFO commandstats

# Monitor memory usage
# redis-cli -a $DRAGONFLY_PASSWORD INFO memory

# Benchmark performance
# redis-benchmark -h <host> -p 6379 -a $DRAGONFLY_PASSWORD -c 50 -n 100000

# ============================================================================
# BACKUP AND RECOVERY
# ============================================================================

# Manual backup (on primary)
# redis-cli -a $DRAGONFLY_PASSWORD BGSAVE

# Automated backup script (run via cron)
# #!/bin/bash
# BACKUP_DIR=/backups/dragonfly/$(date +%Y%m%d)
# mkdir -p $BACKUP_DIR
# redis-cli -a $DRAGONFLY_PASSWORD --rdb $BACKUP_DIR/dump.rdb
# tar -czf $BACKUP_DIR/dragonfly-backup.tar.gz $BACKUP_DIR/dump.rdb
# aws s3 cp $BACKUP_DIR/dragonfly-backup.tar.gz s3://voxguard-backups/dragonfly/

# Recovery from backup
# redis-cli -a $DRAGONFLY_PASSWORD FLUSHALL
# cp /backups/dump.rdb /var/lib/dragonfly/
# systemctl restart dragonfly

# ============================================================================
# TROUBLESHOOTING
# ============================================================================

# Replication broken?
# 1. Check network connectivity: ping <master-host>
# 2. Verify authentication: redis-cli -h <master> -a $DRAGONFLY_PASSWORD ping
# 3. Check replication offset: INFO replication
# 4. Force full resync: REPLICAOF NO ONE && REPLICAOF <master> <port>

# High replication lag?
# 1. Check network latency: ping <master-host>
# 2. Monitor network throughput: iftop
# 3. Increase replication buffer: CONFIG SET repl-backlog-size 512mb
# 4. Check disk I/O: iostat -x 1

# Out of memory?
# 1. Check memory usage: INFO memory
# 2. Evict keys: CONFIG SET maxmemory-policy allkeys-lru
# 3. Increase memory limit: CONFIG SET maxmemory 20gb
# 4. Scale horizontally: Add more replicas
