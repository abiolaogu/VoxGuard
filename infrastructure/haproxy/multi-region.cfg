# HAProxy Multi-Region Load Balancer Configuration
# VoxGuard Production - Global Traffic Management
#
# This HAProxy configuration manages traffic across three Nigerian regions:
# - Lagos (Primary): 70% traffic weight
# - Abuja (Replica): 15% traffic weight
# - Asaba (Replica): 15% traffic weight
#
# Features:
# - Regional failover
# - Session affinity for SIP dialogs
# - Health checks
# - Circuit breaker pattern
# - Geographic load distribution

#=============================================================================
# GLOBAL SETTINGS
#=============================================================================

global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

    # Default SSL material locations
    ca-base /etc/ssl/certs
    crt-base /etc/ssl/private

    # TLS configuration
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Performance tuning
    tune.ssl.default-dh-param 2048
    maxconn 100000
    nbproc 4  # Match number of CPU cores
    nbthread 4

#=============================================================================
# DEFAULTS
#=============================================================================

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 10s
    timeout client  30m  # Long timeout for SIP dialogs
    timeout server  30m
    retries 3
    option  redispatch
    maxconn 50000

#=============================================================================
# STATISTICS & MONITORING
#=============================================================================

# Stats page
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats show-desc VoxGuard Multi-Region Load Balancer
    stats admin if LOCALHOST

# Health check endpoint
frontend health_check
    bind *:8405
    mode http
    monitor-uri /health
    acl lb_healthy nbsrv(opensips_global) ge 1
    http-request use-service prometheus-exporter if { path /metrics }
    monitor fail if !lb_healthy

# Prometheus metrics
listen prometheus
    bind *:9101
    mode http
    http-request use-service prometheus-exporter if { path /metrics }

#=============================================================================
# GLOBAL SIP UDP FRONTEND
#=============================================================================

frontend sip_udp_global
    bind *:5060
    mode tcp
    option tcplog
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"

    # Extract SIP Call-ID for session affinity
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.len gt 0 }

    # Define ACLs for regional routing
    acl from_lagos src 10.0.0.0/16
    acl from_abuja src 10.1.0.0/16
    acl from_asaba src 10.2.0.0/16

    # Route to appropriate backend
    use_backend opensips_lagos if from_lagos
    use_backend opensips_abuja if from_abuja
    use_backend opensips_asaba if from_asaba

    # Default to global backend with weighted distribution
    default_backend opensips_global

#=============================================================================
# GLOBAL SIP TCP FRONTEND
#=============================================================================

frontend sip_tcp_global
    bind *:5061
    mode tcp
    option tcplog

    # Extract SIP Call-ID for session affinity
    tcp-request inspect-delay 5s
    tcp-request content accept if { req.len gt 0 }

    # Regional routing ACLs
    acl from_lagos src 10.0.0.0/16
    acl from_abuja src 10.1.0.0/16
    acl from_asaba src 10.2.0.0/16

    # Route to appropriate backend
    use_backend opensips_lagos_tcp if from_lagos
    use_backend opensips_abuja_tcp if from_abuja
    use_backend opensips_asaba_tcp if from_asaba

    # Default to global backend
    default_backend opensips_global_tcp

#=============================================================================
# GLOBAL SIP TLS FRONTEND
#=============================================================================

frontend sip_tls_global
    bind *:5062 ssl crt /etc/haproxy/certs/voxguard.pem
    mode tcp
    option tcplog

    # Extract SNI for routing
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }

    # Regional routing based on SNI
    acl sni_lagos req_ssl_sni -i lagos.voxguard.ng
    acl sni_abuja req_ssl_sni -i abuja.voxguard.ng
    acl sni_asaba req_ssl_sni -i asaba.voxguard.ng

    use_backend opensips_lagos_tls if sni_lagos
    use_backend opensips_abuja_tls if sni_abuja
    use_backend opensips_asaba_tls if sni_asaba

    default_backend opensips_global_tls

#=============================================================================
# BACKEND: GLOBAL (WEIGHTED DISTRIBUTION)
#=============================================================================

backend opensips_global
    mode tcp
    balance leastconn

    # Session affinity using source IP hash
    # This ensures SIP dialogs stay on the same server
    stick-table type ip size 100k expire 30m
    stick on src

    # Health checks using SIP OPTIONS
    option tcp-check
    tcp-check connect
    tcp-check send "OPTIONS sip:haproxy@localhost SIP/2.0\r\nVia: SIP/2.0/TCP haproxy:5060\r\nFrom: <sip:haproxy@localhost>;tag=haproxy\r\nTo: <sip:localhost>\r\nCall-ID: haproxy-health-check\r\nCSeq: 1 OPTIONS\r\nContent-Length: 0\r\n\r\n"
    tcp-check expect string "SIP/2.0"

    # Circuit breaker: Mark server down after 5 failures
    default-server inter 10s rise 2 fall 5 on-error mark-down on-marked-down shutdown-sessions

    # Lagos region servers (70% weight)
    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5060 check weight 30 maxconn 5000
    server opensips-lagos-2 opensips-lagos-2.voxguard.internal:5060 check weight 20 maxconn 5000
    server opensips-lagos-3 opensips-lagos-3.voxguard.internal:5060 check weight 20 maxconn 5000

    # Abuja region servers (15% weight)
    server opensips-abuja-1 opensips-abuja-1.voxguard.internal:5060 check weight 15 maxconn 3000

    # Asaba region servers (15% weight)
    server opensips-asaba-1 opensips-asaba-1.voxguard.internal:5060 check weight 15 maxconn 3000

backend opensips_global_tcp
    mode tcp
    balance leastconn
    stick-table type ip size 100k expire 30m
    stick on src
    option tcp-check
    default-server inter 10s rise 2 fall 5 on-error mark-down

    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5061 check weight 30 maxconn 5000
    server opensips-lagos-2 opensips-lagos-2.voxguard.internal:5061 check weight 20 maxconn 5000
    server opensips-lagos-3 opensips-lagos-3.voxguard.internal:5061 check weight 20 maxconn 5000
    server opensips-abuja-1 opensips-abuja-1.voxguard.internal:5061 check weight 15 maxconn 3000
    server opensips-asaba-1 opensips-asaba-1.voxguard.internal:5061 check weight 15 maxconn 3000

backend opensips_global_tls
    mode tcp
    balance leastconn
    stick-table type ip size 100k expire 30m
    stick on src
    option tcp-check
    default-server inter 10s rise 2 fall 5 on-error mark-down ssl verify none

    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5062 check weight 30 maxconn 5000
    server opensips-lagos-2 opensips-lagos-2.voxguard.internal:5062 check weight 20 maxconn 5000
    server opensips-lagos-3 opensips-lagos-3.voxguard.internal:5062 check weight 20 maxconn 5000
    server opensips-abuja-1 opensips-abuja-1.voxguard.internal:5062 check weight 15 maxconn 3000
    server opensips-asaba-1 opensips-asaba-1.voxguard.internal:5062 check weight 15 maxconn 3000

#=============================================================================
# BACKEND: LAGOS REGION (PRIMARY)
#=============================================================================

backend opensips_lagos
    mode tcp
    balance roundrobin
    stick-table type ip size 50k expire 30m
    stick on src
    option tcp-check
    default-server inter 5s rise 2 fall 3 on-error mark-down

    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5060 check maxconn 5000
    server opensips-lagos-2 opensips-lagos-2.voxguard.internal:5060 check maxconn 5000
    server opensips-lagos-3 opensips-lagos-3.voxguard.internal:5060 check maxconn 5000

    # Backup to Abuja if all Lagos servers down
    server opensips-abuja-1 opensips-abuja-1.voxguard.internal:5060 check backup

backend opensips_lagos_tcp
    mode tcp
    balance roundrobin
    stick-table type ip size 50k expire 30m
    stick on src
    option tcp-check
    default-server inter 5s rise 2 fall 3 on-error mark-down

    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5061 check maxconn 5000
    server opensips-lagos-2 opensips-lagos-2.voxguard.internal:5061 check maxconn 5000
    server opensips-lagos-3 opensips-lagos-3.voxguard.internal:5061 check maxconn 5000
    server opensips-abuja-1 opensips-abuja-1.voxguard.internal:5061 check backup

backend opensips_lagos_tls
    mode tcp
    balance roundrobin
    stick-table type ip size 50k expire 30m
    stick on src
    option tcp-check
    default-server inter 5s rise 2 fall 3 on-error mark-down ssl verify none

    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5062 check maxconn 5000
    server opensips-lagos-2 opensips-lagos-2.voxguard.internal:5062 check maxconn 5000
    server opensips-lagos-3 opensips-lagos-3.voxguard.internal:5062 check maxconn 5000
    server opensips-abuja-1 opensips-abuja-1.voxguard.internal:5062 check backup

#=============================================================================
# BACKEND: ABUJA REGION (REPLICA)
#=============================================================================

backend opensips_abuja
    mode tcp
    balance roundrobin
    stick-table type ip size 20k expire 30m
    stick on src
    option tcp-check
    default-server inter 10s rise 2 fall 5 on-error mark-down

    server opensips-abuja-1 opensips-abuja-1.voxguard.internal:5060 check maxconn 3000

    # Backup to Lagos if Abuja down
    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5060 check backup

backend opensips_abuja_tcp
    mode tcp
    balance roundrobin
    stick-table type ip size 20k expire 30m
    stick on src
    option tcp-check
    default-server inter 10s rise 2 fall 5 on-error mark-down

    server opensips-abuja-1 opensips-abuja-1.voxguard.internal:5061 check maxconn 3000
    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5061 check backup

backend opensips_abuja_tls
    mode tcp
    balance roundrobin
    stick-table type ip size 20k expire 30m
    stick on src
    option tcp-check
    default-server inter 10s rise 2 fall 5 on-error mark-down ssl verify none

    server opensips-abuja-1 opensips-abuja-1.voxguard.internal:5062 check maxconn 3000
    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5062 check backup

#=============================================================================
# BACKEND: ASABA REGION (REPLICA)
#=============================================================================

backend opensips_asaba
    mode tcp
    balance roundrobin
    stick-table type ip size 20k expire 30m
    stick on src
    option tcp-check
    default-server inter 10s rise 2 fall 5 on-error mark-down

    server opensips-asaba-1 opensips-asaba-1.voxguard.internal:5060 check maxconn 3000

    # Backup to Lagos if Asaba down
    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5060 check backup

backend opensips_asaba_tcp
    mode tcp
    balance roundrobin
    stick-table type ip size 20k expire 30m
    stick on src
    option tcp-check
    default-server inter 10s rise 2 fall 5 on-error mark-down

    server opensips-asaba-1 opensips-asaba-1.voxguard.internal:5061 check maxconn 3000
    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5061 check backup

backend opensips_asaba_tls
    mode tcp
    balance roundrobin
    stick-table type ip size 20k expire 30m
    stick on src
    option tcp-check
    default-server inter 10s rise 2 fall 5 on-error mark-down ssl verify none

    server opensips-asaba-1 opensips-asaba-1.voxguard.internal:5062 check maxconn 3000
    server opensips-lagos-1 opensips-lagos-1.voxguard.internal:5062 check backup

#=============================================================================
# KUBERNETES DEPLOYMENT
#=============================================================================

# ConfigMap for HAProxy configuration
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: haproxy-multi-region-config
  namespace: voxguard-prod
data:
  haproxy.cfg: |
    # Include the above HAProxy configuration here

---
# HAProxy Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: haproxy-multi-region
  namespace: voxguard-prod
  labels:
    app: haproxy
    role: load-balancer
spec:
  replicas: 3  # HA load balancers
  selector:
    matchLabels:
      app: haproxy
  template:
    metadata:
      labels:
        app: haproxy
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - haproxy
            topologyKey: kubernetes.io/hostname
      containers:
      - name: haproxy
        image: haproxy:2.9-alpine
        ports:
        - name: sip-udp
          containerPort: 5060
          protocol: TCP
        - name: sip-tcp
          containerPort: 5061
          protocol: TCP
        - name: sip-tls
          containerPort: 5062
          protocol: TCP
        - name: stats
          containerPort: 8404
          protocol: TCP
        - name: health
          containerPort: 8405
          protocol: TCP
        - name: metrics
          containerPort: 9101
          protocol: TCP
        volumeMounts:
        - name: config
          mountPath: /usr/local/etc/haproxy
        resources:
          requests:
            cpu: 1000m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8405
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8405
          initialDelaySeconds: 5
          periodSeconds: 5
      volumes:
      - name: config
        configMap:
          name: haproxy-multi-region-config

---
# Service for HAProxy
apiVersion: v1
kind: Service
metadata:
  name: haproxy-global
  namespace: voxguard-prod
spec:
  type: LoadBalancer
  selector:
    app: haproxy
  ports:
  - name: sip-udp
    port: 5060
    targetPort: 5060
    protocol: TCP
  - name: sip-tcp
    port: 5061
    targetPort: 5061
    protocol: TCP
  - name: sip-tls
    port: 5062
    targetPort: 5062
    protocol: TCP
  - name: stats
    port: 8404
    targetPort: 8404
    protocol: TCP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 1800  # 30 minutes

#=============================================================================
# MONITORING AND DEBUGGING
#=============================================================================

# View HAProxy stats page
# http://<haproxy-ip>:8404/stats

# Check health endpoint
# curl http://<haproxy-ip>:8405/health

# View Prometheus metrics
# curl http://<haproxy-ip>:9101/metrics

# Test SIP connectivity
# sipsak -s sip:<haproxy-ip>:5060

# Check backend server status
# echo "show servers state" | socat stdio /run/haproxy/admin.sock

# View current connections
# echo "show sess" | socat stdio /run/haproxy/admin.sock

# Enable debug logging
# echo "set severity-output debug" | socat stdio /run/haproxy/admin.sock

#=============================================================================
# TROUBLESHOOTING
#=============================================================================

# All backends down?
# 1. Check network connectivity to each region
# 2. Verify OpenSIPS instances are running
# 3. Test SIP OPTIONS manually
# 4. Check HAProxy logs: journalctl -u haproxy -f

# High latency?
# 1. Check stick-table size: "show table"
# 2. Monitor backend response times in stats page
# 3. Verify regional routing ACLs
# 4. Check for network congestion

# Unbalanced load?
# 1. Review weight distribution (should be 70/15/15)
# 2. Check active connections per server in stats
# 3. Verify session affinity is working
# 4. Consider adjusting maxconn limits

# Health checks failing?
# 1. Increase check interval: inter 20s
# 2. Verify SIP OPTIONS response format
# 3. Check firewall rules between HAProxy and OpenSIPS
# 4. Test manually: sipsak -v -s sip:<opensips-ip>
