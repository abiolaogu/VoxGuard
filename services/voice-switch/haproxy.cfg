#---------------------------------------------------------------------
# HAProxy Configuration for VoxGuard Voice Switch
# Layer 4 (TCP/UDP) Load Balancing for SIP Traffic
# Version: 3.0 | Date: 2026-02-03
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
    # Process management
    maxconn 50000
    daemon
    user haproxy
    group haproxy

    # Logging
    log stdout local0 info
    log-send-hostname

    # Performance tuning
    nbthread 4
    cpu-map auto:1/1-4 0-3
    tune.bufsize 32768
    tune.maxrewrite 8192

    # SSL/TLS settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Stats socket for runtime management
    stats socket /var/run/haproxy.sock mode 660 level admin expose-fd listeners
    stats timeout 30s

#---------------------------------------------------------------------
# Default settings
#---------------------------------------------------------------------
defaults
    mode tcp
    log global
    option tcplog
    option dontlognull
    timeout connect 5s
    timeout client 2m
    timeout server 2m
    timeout check 5s
    maxconn 10000

    # Retries and connection options
    retries 3
    option redispatch

#---------------------------------------------------------------------
# Stats interface
#---------------------------------------------------------------------
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if TRUE
    stats auth admin:voxguard2026
    stats show-legends
    stats show-desc VoxGuard Voice Switch Load Balancer

#---------------------------------------------------------------------
# Health check endpoint
#---------------------------------------------------------------------
listen health
    bind *:8405
    mode http
    monitor-uri /health
    monitor fail if { nbsrv(opensips_cluster) lt 1 }

#---------------------------------------------------------------------
# OpenSIPS Cluster - SIP UDP (port 5060)
#---------------------------------------------------------------------
frontend sip_udp
    bind *:5060
    mode tcp
    default_backend opensips_cluster_udp

    # Connection limits
    maxconn 5000

    # Timeouts optimized for SIP
    timeout client 2m

    # Logging
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"

backend opensips_cluster_udp
    mode tcp
    balance leastconn

    # Health check via SIP OPTIONS
    option tcp-check
    tcp-check send-binary 4f5054494f4e532073697020485454502f312e300d0a # OPTIONS sip HTTP/1.0
    tcp-check expect string 200

    # Server timeouts
    timeout server 2m
    timeout connect 3s

    # Session persistence based on source IP (for SIP dialog affinity)
    stick-table type ip size 1m expire 30m
    stick on src

    # OpenSIPS servers
    server opensips-1 opensips-1:5060 check inter 10s rise 2 fall 3 maxconn 1000
    server opensips-2 opensips-2:5060 check inter 10s rise 2 fall 3 maxconn 1000
    server opensips-3 opensips-3:5060 check inter 10s rise 2 fall 3 maxconn 1000

#---------------------------------------------------------------------
# OpenSIPS Cluster - SIP TCP (port 5060)
#---------------------------------------------------------------------
frontend sip_tcp
    bind *:5061
    mode tcp
    default_backend opensips_cluster_tcp

    maxconn 5000
    timeout client 5m

backend opensips_cluster_tcp
    mode tcp
    balance leastconn

    # TCP health check
    option tcp-check
    tcp-check connect port 5060

    timeout server 5m
    timeout connect 5s

    # SIP dialog affinity
    stick-table type ip size 1m expire 60m
    stick on src

    server opensips-1 opensips-1:5060 check inter 10s rise 2 fall 3 maxconn 1000
    server opensips-2 opensips-2:5060 check inter 10s rise 2 fall 3 maxconn 1000
    server opensips-3 opensips-3:5060 check inter 10s rise 2 fall 3 maxconn 1000

#---------------------------------------------------------------------
# OpenSIPS Cluster - SIP TLS (port 5061)
#---------------------------------------------------------------------
frontend sip_tls
    bind *:5062 ssl crt /etc/haproxy/certs/voxguard.pem
    mode tcp
    default_backend opensips_cluster_tls

    maxconn 3000
    timeout client 5m

backend opensips_cluster_tls
    mode tcp
    balance leastconn

    # TLS health check
    option tcp-check
    tcp-check connect port 5061 ssl

    timeout server 5m
    timeout connect 5s

    # SIP dialog affinity
    stick-table type ip size 1m expire 60m
    stick on src

    server opensips-1 opensips-1:5061 check check-ssl inter 10s rise 2 fall 3 maxconn 800 ssl verify none
    server opensips-2 opensips-2:5061 check check-ssl inter 10s rise 2 fall 3 maxconn 800 ssl verify none
    server opensips-3 opensips-3:5061 check check-ssl inter 10s rise 2 fall 3 maxconn 800 ssl verify none

#---------------------------------------------------------------------
# OpenSIPS Management Interface (MI HTTP)
#---------------------------------------------------------------------
frontend opensips_mi
    bind *:8888
    mode http
    default_backend opensips_mi_cluster

    # HTTP mode settings
    option httplog
    option forwardfor

backend opensips_mi_cluster
    mode http
    balance roundrobin

    # HTTP health check
    option httpchk GET /mi/get_statistics
    http-check expect status 200

    timeout server 30s

    server opensips-1 opensips-1:8888 check inter 10s rise 2 fall 3
    server opensips-2 opensips-2:8888 check inter 10s rise 2 fall 3
    server opensips-3 opensips-3:8888 check inter 10s rise 2 fall 3

#---------------------------------------------------------------------
# ACM Detection Engine Cluster (Backend only - used by OpenSIPS)
#---------------------------------------------------------------------
backend acm_engine_cluster
    mode http
    balance roundrobin

    # Circuit breaker configuration
    # Mark server down after 5 consecutive failures
    # Retry interval: 30s
    option httpchk POST /health
    http-check expect status 200

    default-server inter 5s rise 2 fall 5 on-error mark-down error-limit 5

    timeout server 1s
    timeout connect 200ms

    # ACM detection engine servers
    server acm-engine-1 acm-engine-1:8080 check maxconn 500
    server acm-engine-2 acm-engine-2:8080 check maxconn 500
    server acm-engine-3 acm-engine-3:8080 check maxconn 500

    # Backup server for critical traffic (slower but reliable)
    server acm-engine-backup acm-engine-backup:8080 check maxconn 200 backup

#---------------------------------------------------------------------
# RTP Proxy Cluster (for media handling)
#---------------------------------------------------------------------
frontend rtpproxy_ng
    bind *:22222
    mode tcp
    default_backend rtpproxy_cluster

backend rtpproxy_cluster
    mode tcp
    balance roundrobin

    # Health check
    option tcp-check

    server rtpproxy-1 rtpproxy-1:22222 check inter 10s rise 2 fall 3
    server rtpproxy-2 rtpproxy-2:22222 check inter 10s rise 2 fall 3
    server rtpproxy-3 rtpproxy-3:22222 check inter 10s rise 2 fall 3

#---------------------------------------------------------------------
# Monitoring endpoints for Prometheus
#---------------------------------------------------------------------
frontend prometheus_exporter
    bind *:9101
    mode http
    http-request use-service prometheus-exporter if { path /metrics }
    stats enable
    stats uri /stats
    stats refresh 10s

#---------------------------------------------------------------------
# Error pages
#---------------------------------------------------------------------
# Custom 503 page when all backends are down
errorfile 503 /etc/haproxy/errors/503.http
