name: Continuous Market Intelligence
on:
  schedule:
    - cron: '0 8 * * *' # Daily at 8 AM
  workflow_dispatch:

jobs:
  analyze-market:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Extract Project Context
        id: context
        run: |
          # Extract the first 5 lines of CLAUDE.md to get the Project Name & Core Architecture
          if [ -f "CLAUDE.md" ]; then
            CONTEXT=$(head -n 5 CLAUDE.md)
          else
            CONTEXT="Generic Software Project"
          fi
          echo "PROJECT_CONTEXT<<EOF" >> $GITHUB_ENV
          echo "$CONTEXT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Autonomous Surveillance
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            YOU ARE THE INTELLIGENCE OFFICER FOR THIS PROJECT:
            ${{ env.PROJECT_CONTEXT }}

            TASK: Perform deep-dive market surveillance for THIS specific product domain.

            1. **Understand the Product:** Based on the context above, identify our niche (e.g., "Lottery App", "HR SaaS", "Crypto Wallet").
            2. **Scan the Market:** Search for news, competitor changelogs, and trend reports from the last 24 hours relevant to this niche.
            3. **Filter Signal vs. Noise:** Ignore generic tech news. Focus ONLY on:
               - New features launched by direct competitors.
               - Regulatory changes affecting this specific industry.
               - Viral user complaints about competitor products (opportunities for us).

            ACTIONABLE OUTPUT:
            If you find a feature or trend that we should implement to stay competitive:
            - Create a GitHub Issue using the CLI or API tools.
            - Title: "feat(intelligence): [Feature Name] detected in market"
            - Body: Provide a summary of the feature, which competitor launched it, and a brief recommendation on how we can implement it.

            If no significant updates are found, output a simple log message "No actionable intelligence today."
