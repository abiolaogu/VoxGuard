name: Research Ingestion Pipeline
on:
  push:
    paths:
      - 'research/incoming/**'
  workflow_dispatch:

jobs:
  # PHASE 1: Detect the file and open a "Ticket" for Claude
  create-analysis-ticket:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect New Files & Open Issue
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            
            // 1. Find what changed in the research folder
            try {
              const diff = execSync('git diff --name-only HEAD~1 HEAD | grep "research/incoming/" || true').toString().trim();
              if (!diff) {
                console.log("No new research files found.");
                return;
              }
              
              const files = diff.split('\n').filter(Boolean);

              // 2. Create an Issue for each file to trigger Claude
              for (const file of files) {
                const fileName = file.split('/').pop();
                
                // The PROMPT goes here, inside the issue body
                const analysisPrompt = `
                @claude **SYSTEM EVENT:** New research detected in \`${file}\`.
                
                **TASK:** Analyze this research artifact and extract product opportunities.
                
                1. **Summarize:** What is this document about? (Market Report, Competitor News, etc.)
                2. **Extract:** List any key "Opportunities" or "Gaps" identified.
                3. **Recommend:** If valid, suggest a new product concept.
                
                (Note: Please read the file content from the repository context).
                `;

                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `üïµÔ∏è Research Ingestion: ${fileName}`,
                  body: analysisPrompt,
                  labels: ['research-ingestion', 'trigger-claude']
                });
                
                console.log(`Created issue for ${fileName}`);
              }
            } catch (error) {
              console.error("Error processing git diff:", error);
              core.setFailed(error.message);
            }
