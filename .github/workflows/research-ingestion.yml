name: Research Ingestion Pipeline
on:
  push:
    paths:
      - 'research/incoming/**'
  workflow_dispatch:

jobs:
  ingest-research:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect New Research
        id: detect
        run: |
          NEW_FILES=$(git diff --name-only HEAD~1 HEAD | grep 'research/incoming/' || echo "")
          echo "files=$NEW_FILES" >> $GITHUB_OUTPUT

      - name: Process with Claude
        if: steps.detect.outputs.files != ''
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            TASK: Analyze the newly added research files: ${{ steps.detect.outputs.files }}

            1. Extract key market insights and product opportunities.
            2. Define validation criteria and recommended tech stack.
            3. OUTPUT: Generate a JSON object describing the "Opportunity".

      - name: Create Opportunity Issue
        if: steps.detect.outputs.files != ''
        uses: actions/github-script@v7
        with:
          script: |
            // In a real scenario, we parse the JSON from Claude.
            // For this template, we create a placeholder issue to demonstrate the flow.
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "[Opportunity] New Market Signal Detected",
              body: "### Research Ingestion Report\n\nNew files were detected in `research/incoming/`. \n\n**Action Required:** Review extracted insights and add 'approved-for-development' label to initiate product.",
              labels: ['research-insight', 'opportunity', 'P1']
            });
