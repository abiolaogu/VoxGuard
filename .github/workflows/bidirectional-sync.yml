name: Bidirectional Sync
on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target Repository (e.g., billyronks/child-repo)'
        required: true
      sync_path:
        description: 'Path mapping (e.g., packages/core:src/core)'
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: source

      - name: Checkout Target
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.target_repo }}
          token: ${{ secrets.FACTORY_ADMIN_TOKEN }}
          path: target

      - name: Perform Intelligent Sync
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            TASK: Sync code from Source to Target based on this mapping: ${{ inputs.sync_path }}

            SOURCE PATH: source/${{ inputs.sync_path }} (Left side of mapping)
            TARGET PATH: target/${{ inputs.sync_path }} (Right side of mapping)

            INSTRUCTIONS:
            1. Compare the files in the source and target paths.
            2. Copy updated files from Source -> Target.
            3. If a file exists in both but has different content, attempt to merge them.
            4. IMPORTANT: Output a bash script to perform the file copy/moves in the 'target' directory.

      - name: Push Changes
        working-directory: target
        run: |
          git config user.name "Factory Sync Bot"
          git config user.email "bot@billyronks.com"
          git add .
          git commit -m "sync: Update from parent repository" || echo "No changes to sync"
          git push origin main
