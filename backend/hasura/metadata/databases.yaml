version: 3
sources:
  - name: default
    kind: postgres
    tables:
      # ============================================================================
      # Anti-Masking Context
      # ============================================================================
      - table:
          schema: public
          name: carriers
        select_permissions:
          - role: user
            permission:
              columns: [id, code, name, country_code, prefixes, is_active]
              filter: { is_active: { _eq: true } }
          - role: analyst
            permission:
              columns: '*'
              filter: {}
          - role: admin
            permission:
              columns: '*'
              filter: {}
        insert_permissions:
          - role: admin
            permission:
              columns: '*'
              check: {}
        update_permissions:
          - role: admin
            permission:
              columns: '*'
              filter: {}
              
      - table:
          schema: public
          name: gateways
        object_relationships:
          - name: carrier
            using:
              foreign_key_constraint_on: carrier_id
        select_permissions:
          - role: analyst
            permission:
              columns: '*'
              filter: {}
          - role: admin
            permission:
              columns: '*'
              filter: {}
        insert_permissions:
          - role: admin
            permission:
              columns: '*'
              check: {}
        update_permissions:
          - role: admin
            permission:
              columns: '*'
              filter: {}
              
      - table:
          schema: public
          name: call_verifications
        object_relationships:
          - name: gateway
            using:
              foreign_key_constraint_on: gateway_id
          - name: a_carrier
            using:
              foreign_key_constraint_on: a_carrier_id
          - name: b_carrier
            using:
              foreign_key_constraint_on: b_carrier_id
          - name: alert
            using:
              foreign_key_constraint_on: alert_id
        select_permissions:
          - role: analyst
            permission:
              columns: '*'
              filter: {}
          - role: admin
            permission:
              columns: '*'
              filter: {}
              
      - table:
          schema: public
          name: fraud_alerts
        array_relationships:
          - name: calls
            using:
              foreign_key_constraint_on:
                column: alert_id
                table:
                  schema: public
                  name: call_verifications
        select_permissions:
          - role: analyst
            permission:
              columns: '*'
              filter: {}
          - role: admin
            permission:
              columns: '*'
              filter: {}
        update_permissions:
          - role: analyst
            permission:
              columns: [status, acknowledged_by, acknowledged_at, resolution, resolution_notes, resolved_by, resolved_at]
              filter: {}
          - role: admin
            permission:
              columns: '*'
              filter: {}
              
      - table:
          schema: public
          name: blacklist
        select_permissions:
          - role: analyst
            permission:
              columns: '*'
              filter: { is_active: { _eq: true } }
          - role: admin
            permission:
              columns: '*'
              filter: {}
        insert_permissions:
          - role: analyst
            permission:
              columns: [entry_type, value, reason, source, added_by, alert_id, expires_at]
              check: {}
          - role: admin
            permission:
              columns: '*'
              check: {}
              
      - table:
          schema: public
          name: domain_events
        select_permissions:
          - role: admin
            permission:
              columns: '*'
              filter: {}
              
      # ============================================================================
      # Remittance Context
      # ============================================================================
      - table:
          schema: public
          name: remittance_corridors
        select_permissions:
          - role: user
            permission:
              columns: [id, source_country, destination_country, source_currency, destination_currency, exchange_rate, fee_structure, min_amount, max_amount, processing_time_hours, is_active]
              filter: { is_active: { _eq: true } }
          - role: admin
            permission:
              columns: '*'
              filter: {}
              
      - table:
          schema: public
          name: nigerian_banks
        select_permissions:
          - role: user
            permission:
              columns: [id, code, name, short_name, is_active, supports_instant_transfer]
              filter: { is_active: { _eq: true } }
          - role: admin
            permission:
              columns: '*'
              filter: {}
              
      - table:
          schema: public
          name: beneficiaries
        object_relationships:
          - name: bank
            using:
              foreign_key_constraint_on: bank_id
        select_permissions:
          - role: user
            permission:
              columns: '*'
              filter: { user_id: { _eq: 'X-Hasura-User-Id' } }
        insert_permissions:
          - role: user
            permission:
              columns: [first_name, last_name, middle_name, relationship, bank_code, account_number, phone_number, email]
              check: {}
              set:
                user_id: 'X-Hasura-User-Id'
        update_permissions:
          - role: user
            permission:
              columns: [first_name, last_name, relationship, phone_number, email, is_favorite]
              filter: { user_id: { _eq: 'X-Hasura-User-Id' } }
        delete_permissions:
          - role: user
            permission:
              filter: { user_id: { _eq: 'X-Hasura-User-Id' } }
              
      - table:
          schema: public
          name: remittance_transactions
        object_relationships:
          - name: beneficiary
            using:
              foreign_key_constraint_on: beneficiary_id
          - name: corridor
            using:
              foreign_key_constraint_on: corridor_id
        select_permissions:
          - role: user
            permission:
              columns: '*'
              filter: { sender_id: { _eq: 'X-Hasura-User-Id' } }
          - role: admin
            permission:
              columns: '*'
              filter: {}
              
      # ============================================================================
      # Marketplace Context
      # ============================================================================
      - table:
          schema: public
          name: service_categories
        select_permissions:
          - role: user
            permission:
              columns: '*'
              filter: { is_active: { _eq: true } }
          - role: provider
            permission:
              columns: '*'
              filter: { is_active: { _eq: true } }
              
      - table:
          schema: public
          name: provider_profiles
        object_relationships:
          - name: state
            using:
              foreign_key_constraint_on: state_id
        select_permissions:
          - role: user
            permission:
              columns: [id, business_name, description, logo_url, state_id, city, average_rating, total_reviews, verification_status, tier, is_active]
              filter: { is_active: { _eq: true } }
          - role: provider
            permission:
              columns: '*'
              filter: { user_id: { _eq: 'X-Hasura-User-Id' } }
        update_permissions:
          - role: provider
            permission:
              columns: [business_name, description, logo_url, cover_image_url, phone_primary, phone_secondary, email, website, instagram, facebook, twitter, whatsapp]
              filter: { user_id: { _eq: 'X-Hasura-User-Id' } }
              
      - table:
          schema: public
          name: marketplace_listings
        object_relationships:
          - name: provider
            using:
              foreign_key_constraint_on: provider_id
          - name: category
            using:
              foreign_key_constraint_on: category_id
          - name: state
            using:
              foreign_key_constraint_on: state_id
        select_permissions:
          - role: user
            permission:
              columns: '*'
              filter: { status: { _eq: 'ACTIVE' } }
          - role: provider
            permission:
              columns: '*'
              filter:
                provider:
                  user_id: { _eq: 'X-Hasura-User-Id' }
                  
      - table:
          schema: public
          name: marketplace_orders
        object_relationships:
          - name: listing
            using:
              foreign_key_constraint_on: listing_id
          - name: provider
            using:
              foreign_key_constraint_on: provider_id
        select_permissions:
          - role: user
            permission:
              columns: '*'
              filter: { customer_id: { _eq: 'X-Hasura-User-Id' } }
          - role: provider
            permission:
              columns: '*'
              filter:
                provider:
                  user_id: { _eq: 'X-Hasura-User-Id' }
              
      # ============================================================================
      # Identity Context
      # ============================================================================
      - table:
          schema: public
          name: users
        select_permissions:
          - role: user
            permission:
              columns: [id, first_name, last_name, display_name, avatar_url, email, phone, role, status, kyc_level]
              filter: { id: { _eq: 'X-Hasura-User-Id' } }
          - role: admin
            permission:
              columns: '*'
              filter: {}
        update_permissions:
          - role: user
            permission:
              columns: [first_name, last_name, middle_name, display_name, avatar_url, date_of_birth, gender, language, notifications_email, notifications_push, notifications_sms]
              filter: { id: { _eq: 'X-Hasura-User-Id' } }
              
      - table:
          schema: public
          name: notifications
        select_permissions:
          - role: user
            permission:
              columns: '*'
              filter: { user_id: { _eq: 'X-Hasura-User-Id' } }
        update_permissions:
          - role: user
            permission:
              columns: [is_read, read_at]
              filter: { user_id: { _eq: 'X-Hasura-User-Id' } }
              
    configuration:
      connection_info:
        database_url:
          from_env: HASURA_GRAPHQL_DATABASE_URL
        pool_settings:
          max_connections: 50
          idle_timeout: 180
        isolation_level: read-committed
