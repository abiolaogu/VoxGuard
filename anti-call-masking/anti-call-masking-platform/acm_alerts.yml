# ============================================================================
# Prometheus Alert Rules - Anti-Call Masking Platform
# Version: 2.0 | Date: 2026-01-22
# ============================================================================

groups:
  # ==========================================================================
  # FRAUD DETECTION ALERTS
  # ==========================================================================
  - name: fraud_detection
    interval: 30s
    rules:
      # High fraud rate
      - alert: HighFraudRate
        expr: |
          (
            sum(rate(acm_fraud_detected_total[5m])) 
            / sum(rate(acm_detections_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          team: fraud-ops
        annotations:
          summary: "High fraud detection rate ({{ $value | humanizePercentage }})"
          description: "Fraud rate exceeds 5% threshold over last 5 minutes"
          runbook: "https://wiki.acm.ng/runbooks/high-fraud-rate"

      # SIM-box outbreak
      - alert: SimBoxOutbreak
        expr: |
          sum(rate(acm_fraud_detected_total{fraud_type="SIM_BOX"}[5m])) > 10
        for: 2m
        labels:
          severity: critical
          team: fraud-ops
        annotations:
          summary: "SIM-box outbreak detected ({{ $value | humanize }}/sec)"
          description: "Unusual spike in SIM-box fraud detections"

      # Call masking spike
      - alert: CallMaskingSpike
        expr: |
          sum(rate(acm_fraud_detected_total{fraud_type="CLI_MASK"}[5m])) > 20
        for: 2m
        labels:
          severity: warning
          team: fraud-ops
        annotations:
          summary: "Call masking spike detected ({{ $value | humanize }}/sec)"
          description: "Elevated call masking attempts from international gateways"

      # New fraud source
      - alert: NewFraudSource
        expr: |
          count(
            count by (source_ip) (
              acm_fraud_detected_total{fraud_type!=""}
            ) unless count by (source_ip) (
              acm_fraud_detected_total{fraud_type!=""} offset 1h
            )
          ) > 5
        for: 5m
        labels:
          severity: warning
          team: fraud-ops
        annotations:
          summary: "Multiple new fraud sources detected"
          description: "More than 5 new IPs detected as fraud sources in last hour"

  # ==========================================================================
  # DETECTION ENGINE ALERTS
  # ==========================================================================
  - name: detection_engine
    interval: 15s
    rules:
      # High detection latency
      - alert: HighDetectionLatency
        expr: |
          histogram_quantile(0.99, 
            sum(rate(acm_detection_latency_microseconds_bucket[5m])) by (le)
          ) > 1000
        for: 3m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Detection latency p99 > 1ms ({{ $value | humanize }}µs)"
          description: "Detection engine latency exceeds target SLA"

      # Critical detection latency
      - alert: CriticalDetectionLatency
        expr: |
          histogram_quantile(0.99, 
            sum(rate(acm_detection_latency_microseconds_bucket[5m])) by (le)
          ) > 5000
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Detection latency p99 > 5ms ({{ $value | humanize }}µs)"
          description: "Detection engine severely degraded"

      # Detection engine down
      - alert: DetectionEngineDown
        expr: up{job="acm-detection-engine"} == 0
        for: 1m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "Detection engine is down"
          description: "ACM detection engine instance is not responding"

      # Low throughput
      - alert: LowDetectionThroughput
        expr: |
          sum(rate(acm_calls_processed_total[5m])) < 100
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Low detection throughput ({{ $value | humanize }}/sec)"
          description: "Detection throughput significantly below normal levels"

  # ==========================================================================
  # CACHE ALERTS (DragonflyDB)
  # ==========================================================================
  - name: cache
    interval: 30s
    rules:
      # Low cache hit rate
      - alert: LowCacheHitRate
        expr: |
          (
            sum(rate(acm_cache_hits_total[5m])) 
            / (sum(rate(acm_cache_hits_total[5m])) + sum(rate(acm_cache_misses_total[5m])))
          ) < 0.90
        for: 10m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Cache hit rate below 90% ({{ $value | humanizePercentage }})"
          description: "MNP/blacklist cache hit rate is degraded"

      # Cache connection issues
      - alert: CacheConnectionError
        expr: |
          sum(rate(acm_cache_errors_total[5m])) > 1
        for: 5m
        labels:
          severity: critical
          team: platform
        annotations:
          summary: "DragonflyDB connection errors"
          description: "Multiple cache connection errors detected"

      # High cache latency
      - alert: HighCacheLatency
        expr: |
          histogram_quantile(0.99,
            sum(rate(acm_cache_latency_microseconds_bucket[5m])) by (le)
          ) > 500
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Cache latency p99 > 500µs"
          description: "DragonflyDB response time degraded"

  # ==========================================================================
  # DATABASE ALERTS (YugabyteDB)
  # ==========================================================================
  - name: database
    interval: 30s
    rules:
      # Database connection pool exhausted
      - alert: DatabaseConnectionsHigh
        expr: |
          acm_db_connections_active{database="yugabyte"} > 50
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "High database connection usage"
          description: "YugabyteDB connection pool nearing exhaustion"

      # High query latency
      - alert: HighDatabaseLatency
        expr: |
          histogram_quantile(0.99,
            sum(rate(acm_db_query_latency_milliseconds_bucket[5m])) by (le, database)
          ) > 100
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Database query latency p99 > 100ms"
          description: "Database queries taking longer than expected"

  # ==========================================================================
  # NCC COMPLIANCE ALERTS
  # ==========================================================================
  - name: ncc_compliance
    interval: 60s
    rules:
      # NCC reporting failures
      - alert: NCCReportingFailure
        expr: |
          sum(rate(acm_ncc_reports_failed_total[15m])) > 0.1
        for: 5m
        labels:
          severity: warning
          team: compliance
        annotations:
          summary: "NCC ATRS reporting failures"
          description: "Failed to submit fraud reports to NCC"

      # High unreported fraud backlog
      - alert: NCCReportBacklog
        expr: |
          acm_ncc_unreported_count > 100
        for: 30m
        labels:
          severity: critical
          team: compliance
        annotations:
          summary: "NCC report backlog exceeds 100 events"
          description: "Significant backlog of unreported fraud events to NCC"

  # ==========================================================================
  # GATEWAY ALERTS
  # ==========================================================================
  - name: gateways
    interval: 30s
    rules:
      # Gateway with high fraud rate
      - alert: GatewayHighFraudRate
        expr: |
          acm_gateway_fraud_rate > 0.1
        for: 10m
        labels:
          severity: warning
          team: fraud-ops
        annotations:
          summary: "Gateway {{ $labels.gateway_id }} fraud rate > 10%"
          description: "Gateway showing elevated fraud rate - consider blacklisting"

      # Gateway blocked
      - alert: GatewayBlocked
        expr: |
          acm_gateway_blocked == 1
        labels:
          severity: info
          team: operations
        annotations:
          summary: "Gateway {{ $labels.gateway_id }} has been blocked"
          description: "A gateway was automatically blocked due to fraud detection"

  # ==========================================================================
  # SYSTEM ALERTS
  # ==========================================================================
  - name: system
    interval: 30s
    rules:
      # High memory usage
      - alert: HighMemoryUsage
        expr: |
          acm_memory_bytes / (4 * 1024 * 1024 * 1024) > 0.85
        for: 5m
        labels:
          severity: warning
          team: platform
        annotations:
          summary: "Detection engine memory usage > 85%"
          description: "Memory usage is high, may cause OOM"

      # Service uptime
      - alert: RecentRestart
        expr: |
          acm_uptime_seconds < 300
        labels:
          severity: info
          team: platform
        annotations:
          summary: "Detection engine recently restarted"
          description: "Service was restarted within last 5 minutes"
